# 活动架构

## 序
    开发的担当：通过优秀的架构，提高各方工作效能！

## 三个小故事

### 不要随便相信第三方开发

很久很久以前，某第三方厂商希望在我们的某App上面放置其开发的活动页面。<br/>
当时不做多想，采用的方式就是为cp提供活动页面所需的客户端接口的文档，然后由cp自行适配和开发。<br/>
以往都是需要我们来开发页面的，现在它们自己开发了，真好！<br/>
理想很美好，现实很骨感！<br/>
由于技术水平、熟悉程度和无法当面沟通等问题，我们花了大量的时间，教他入门，最后甚至帮他修改代码！<br/>
耗费了大量人力，堪比自己开发。<br/>

so 

* 不要随便相信第三方开发（说不定，他会随便派一个应届毕业生来跟你做对接；也有可能还没毕业）
* 不要随便提供接口文档给第三方，裸奔不安全，也不友好
* 不要太依赖文档，你写的文档，他人要么不看，要么看不懂

### 不要随意相信需求方

你说你要一匹跑得更快的马，其实你是要一辆跑车……

#### 关于Deep Link
这是一种实现在不同的app间进行跳转的技术方案，其流程大致如下：

![deeplink流程](../../../images/work/activity/deeplink.jpg)

* Deep Link、scheme、schema
    * 简单粗暴的理解：Deep Link是实现跳转的一种技术方案，scheme、schema都是指跳转使用的路径（其实不完全是）
    * scheme是指URL的协议部分，在Deep Link中，理想状态下，一个sheme对应一个app（其实不完全是）

####  故事情节

某天，接到一个简单的需求：点击push，跳转第三方APP活动页面（CPC）;<br/>
看似简单，但是细心一想，其实只有已经安装的，能进行成功跳转，而未安装的，需要提供下载安装功能、良好的交互与视觉效果。<br/>
基于之前踩过的坑，这次决定采用一种更加灵活和复用性更强的架构，支持两种模式：

* 默认简易模式
    * 页面简单，只有APP Icon和下载按钮
    * 无需开发，只需要非常简单的配置，即可生成活动
* 自行定制模式
    * cp可根据需要自行开发定制页面UI和交互
    * 需要加入我们提供的少量代码

![deeplink两种模式](../../../images/work/activity/two_mode.png)

实现方式：
以承载页嵌套内容页的方式，承载页负责逻辑，由我们实现，内容页负责展示，由cp实现。两个页面通过`PostMessage`进行通信

![PostMessage](../../../images/work/activity/postmessage.png)

看起来很完美，然而，随之而来的是：

* 默认简易模式被嫌弃太简陋，导致每次都要定制
* cp每次都想定制，但是又不想自己开发
* 少部分愿意自己开发的cp，沟通成本非常高

### 不要随意相信自己

* 你自己写的埋点文档，过两天自己都找不到了
* 你自己写的埋点逻辑，过两天自己都忘了
* 同样的功能，每次写的文档和代码都会或多或少有点差异
* ...

## deeplink活动模版

### 架构

![architecture](../../../images/work/activity/architecture.png)

### scene配置平台

* flyme内部用于配置各种营销页面的平台
* 平台水土不服，演化出来一系列的工具和说明文档

### 文档

* cp deeplink活动模版说明
* deeplink内容页配置平台使用教程
* deeplink导航页配置教程

### 工具

* 多机型测试工具
* 路径生成工具
* deeplink流程模拟测试
* 导航页代码生成工具

### 未来

一个综合性配置平台，涵盖和汇总以上功能

## 发散

### 联合活动

* 现有架构（公共包引入）

![architecture](../../../images/work/activity/game_old_architecture.png)

* 理想架构（公共服务提供）

![architecture](../../../images/work/activity/game_new_architecture.png)

* 更少的改动，更稳定、高效的完成
* 更简单的内容页，配置化的可能性更高
* 更高的接入可能性（客户端接口适配问题、埋点和业务逻辑问题，游戏活动）

## 业务前端方法论

* 通常来讲，没有无聊的项目，只有不行的你，把项目给做无聊了
* 不做纯架构，也不做纯业务，两者有机结合
* 现在小步慢跑，希望一直再跑，然后越跑越快
* 我们的目标是解决问题，而不只是提高技术水平
