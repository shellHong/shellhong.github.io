var winH=window.innerHeight,winW=window.innerWidth,HEIGHT=1E3,WIDTH=800,treeRight=360,scale=1,isMobile=/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent);
if(isMobile){scale=Math.min(window.innerWidth/HEIGHT,window.innerHeight/WIDTH);winH<HEIGHT&&(winH/=scale);400>winW&&(document.getElementById("output-wrap").style.left="10%");winW<WIDTH&&(winW/=scale);1>scale&&document.querySelector('meta[name="viewport"]').setAttribute("content","width=device-width, initial-scale="+scale+", maximum-scale="+scale+", user-scalable=no");var temp=.3*winW;treeRight>temp&&(treeRight=temp)}
var flowers=[],branches=[],offsetH=30,flowerMax=0,flowerMin=600,startH=winH-offsetH,seed={i:0,x:winW-treeRight,y:startH,a:0,l:120,d:0},da=.5,dl=.8,ar=.7,maxDepth=10,angle=da,mainSvg=d3.select("svg"),halfW=winW/3,qW=halfW/2,bottomH=4;
function branch(a){var b=endPt(a),c;branches.push(a);a.d===maxDepth?(flowerMax=Math.max(a.y,flowerMax),flowerMin=Math.min(a.y,flowerMin),flowers.push(a)):(c=ar*Math.random()-.5*ar,angle=3>a.d?.4:da,c={i:branches.length,x:b.x,y:b.y,a:a.a-angle+c,l:a.l*dl,d:a.d+1,parent:a.i},branch(c),c=ar*Math.random()-.5*ar,angle=3>a.d?.3:da,c={i:branches.length,x:b.x,y:b.y,a:a.a+angle+c,l:a.l*dl,d:a.d+1,parent:a.i},branch(c))}function regenerate(){branches=[];branch(seed);create()}
function endPt(a){var b=a.l;2>a.d&&(b+=50);return{x:a.x+b*Math.sin(a.a),y:a.y-b*Math.cos(a.a)}}function x1(a){return a.x}function y1(a){return a.y}function x2(a){return endPt(a).x}function y2(a){return endPt(a).y}function getPoint(a,b,c,d,e){c-=a;d-=b;e/=Math.sqrt(Math.pow(c,2)+Math.pow(d,2));return[a+c*e,b+d*e]}var heartStartX=0,heartStartY=0;
function transform(a,b,c){var d=b/2,e=c/2,g=winW/2,f=winH/2;return r=a.replace(/m([-\d\.]+),([-\d\.]+)/g,function(){var a=arguments;heartStartX=parseFloat(a[1])+g-d;heartStartY=parseFloat(a[2])+f-e;return"m"+heartStartX+","+heartStartY})}
function createHeartPath(){return new Promise(function(a,b){mainSvg.append("path").attr("id","heartPath").style("stroke","red").style("stroke-width",1).attr("d",transform("m29.727744,14.504978c11.750414,-31.304472 57.78892,0 0,40.248607c-57.78892,-40.248607 -11.750414,-71.553079 0,-40.248607z",57,53)).attr("fill-opacity",0).classed("appearHeartPath",!0);a()})}
function createTipLine(){return new Promise(function(a,b){mainSvg.append("line").style("stroke-width",1).attr("id","tipLine").style("stroke","red").transition().delay(function(a,b){return 2500}).attr("x1",heartStartX+15+16).attr("y1",heartStartY+30).attr("x2",heartStartX+15+16).attr("y2",heartStartY+30).transition().delay(function(a,b){return 0}).duration(2E3).attr("x2",heartStartX+100+16).attr("y2",heartStartY+30).on("end",function(){a()})})}
function createTipText(){return new Promise(function(a,b){mainSvg.append("text").attr("id","tipText").transition().delay(function(a,b){return 0}).style("fill","red").attr("x",heartStartX+17+16).attr("y",heartStartY+23).text("\u8bf7\u70b9\u51fb\u7ea2\u5fc3").attr("fill-opacity",0).transition().duration(1E3).attr("fill-opacity",.6).on("end",function(){a()})})}
function addHeartListener(){return new Promise(function(a,b){var c=mainSvg.select("#heartPath"),d=mainSvg.select("#tipText"),e=mainSvg.select("#tipLine");c.on("click",function(){d.remove();e.remove();c.classed("appearHeartPath",!1);c.classed("disappearHeartPath",!0);var b=getPoint(heartStartX,heartStartY,0,winH,190),f=getPoint(0,winH,heartStartX,heartStartY,190);mainSvg.append("line").style("stroke","red").attr("x1",heartStartX).attr("y1",heartStartY).attr("x2",heartStartX).attr("y2",heartStartY).transition().delay(function(a,
b){return 0}).duration(3E3).ease(d3.easeLinear).attr("x2",b[0]).attr("y2",b[1]).transition().delay(function(a,b){return 0}).duration(3E3).ease(d3.easeLinear).attr("x2",0).attr("y2",winH).attr("x1",f[0]).attr("y1",f[1]).transition().delay(function(a,b){return 0}).ease(d3.easeLinear).duration(1E3).attr("x1",0).attr("y1",winH).remove().on("end",function(){mainSvg.select("#heartPath").remove();a()})})})}
function createHeart(){createHeartPath().then(createTipLine).then(createTipText).then(addHeartListener).then(regenerate)}function create(){createGround().then(createChair).then(createPeople).then(createTree).then(createFlowers).then(createText)}
function createGround(){return new Promise(function(a,b){mainSvg.append("path").classed("groundPath",!0).style("stroke-dasharray",1.1*winW).style("stroke-dashoffset",1.1*winW).style("stroke","#cacaca").style("stroke-width",bottomH).attr("d","m0,"+(winH-bottomH)+"h"+halfW+"c"+(halfW+halfW/6)+",-65 "+(halfW+halfW/4)+",-45 "+winW+",0").attr("fill","#d4d4d4").attr("fill-opacity",0).transition().delay(function(a,b){return 5E3}).duration(500).attr("fill-opacity",1).on("end",function(){document.getElementById("groundFill").style.display=
"block";a()})})}function createChair(){return new Promise(function(a,b){mainSvg.append("path").classed("chairPath",!0).style("stroke","#a58b8b").style("stroke-width",1).attr("d","m"+qW+","+(winH-bottomH-13)+"h100v13h-100v-13").attr("fill","#a68b9b").attr("fill-opacity",0).transition().delay(function(a,b){return 3E3}).duration(500).attr("fill-opacity",1).on("end",function(){a()})})}
function createPeople(){return new Promise(function(a,b){document.getElementById("people").style.left=qW+"px";d3.select("#people").append("path").classed("peoplePath",!0).style("stroke","#4a4a4a").style("stroke-width",1.5).attr("d","m102.36685,19.712079c-3.509374,3.348599 -18.622442,7.595834 -20.571686,7.595834l-16.566741,0c-2.749499,0 -6.890267,0.463507 -8.839511,1.526104c0.223924,0.170268 0.447849,0.340536 0.664432,0.513956c1.497724,1.195027 4.999757,2.878786 8.097991,2.878786c1.457345,0 2.654056,-0.362607 3.670893,-1.1162c4.324312,-3.175178 6.570899,-3.547245 7.874066,-3.547245c1.545446,0 2.874309,0.60855 3.65621,1.6743c1.468357,1.973845 0.389115,4.556239 -0.712153,6.580533c-2.635701,4.805334 -11.225592,9.998501 -20.538648,9.998501c-0.007342,0 -0.007342,0 -0.014684,0c-1.299496,0 -2.573296,-0.104053 -3.792033,-0.312158l0,10.250749c0,2.339605 3.792033,7.986819 15.296612,7.986819s14.518383,-11.669647 14.518383,-13.678176l0,-14.226817c8.186092,-3.685982 16.56307,-5.691357 20.571686,-12.28135c3.770007,-6.192701 0.190886,-7.192236 -3.314817,-3.843637zm-25.732962,14.901582c2.922031,-5.357128 -0.194557,-5.357128 -5.653176,-1.34007s-13.453824,0.331076 -16.181298,-1.844567c-2.727474,-2.17249 -5.454947,-3.84679 -10.329894,-3.679675c-4.874946,0.167115 -16.372184,-0.50765 -23.005488,-1.844567c-6.625962,-1.34007 -17.969023,-9.45932 -18.9051,-7.362504c-0.976458,2.175644 0.774558,3.682828 4.287603,7.362504c3.505703,3.685982 18.629783,8.75933 18.629783,8.75933s0,10.887677 0,15.406079c0,4.524708 10.913566,11.382715 16.56307,11.382715s9.940779,-3.348599 9.940779,-5.69451l0,-14.226817c9.357107,4.193632 21.731688,-1.557635 24.653719,-6.917916zm-5.873429,-11.953427c6.402038,0 11.596352,-4.458493 11.596352,-9.957511c0,-5.502171 -5.194314,-9.960664 -11.596352,-9.960664s-11.592681,4.458493 -11.592681,9.960664c0,5.499018 5.190643,9.957511 11.592681,9.957511zm-30.552845,0c6.402038,0 11.592681,-4.458493 11.592681,-9.957511c0,-5.502171 -5.190643,-9.960664 -11.592681,-9.960664c-6.405709,0 -11.596352,4.458493 -11.596352,9.960664c0,5.499018 5.186972,9.957511 11.596352,9.957511z").attr("fill-opacity",
0);setTimeout(function(){a()},2E3)})}function createTree(){return new Promise(function(a,b){mainSvg.selectAll("line").data(branches).enter().append("line").attr("x1",x1).attr("y1",y1).attr("x2",x1).attr("y2",y1).style("stroke-width",function(a){return parseInt(maxDepth+1-a.d)+"px"}).attr("id",function(a){return"id-"+a.i}).transition().delay(function(a,b){return 10*b}).duration(500).ease(d3.easeLinear).attr("x2",x2).attr("y2",y2).on("end",function(b,d){d+1==branches.length&&a()})})}
function createFlowers(){return new Promise(function(a,b){isMobile||mainSvg.append("defs").append("filter").attr("id","Gaussian_Blur").append("feGaussianBlur").attr("in","SourceGraphic").attr("stdDeviation",2);b=mainSvg.selectAll("circle").data(flowers).enter().append("circle").attr("cx",x2).attr("cy",y2).attr("r",0).attr("fill","#f7acbc").transition().delay(function(a,b){return b%5}).duration(500).attr("r",5);b=isMobile?b.style("fill-opacity",".6"):b.style("filter","url(#Gaussian_Blur)");b.on("end",
function(b,d){d+1==flowers.length&&(a(),document.getElementById("output-wrap").style.display="block")})})}
function createText(){return new Promise(function(a,b){setTimeout(function(){var b=document.getElementById("output-wrap");b.style.top=winH-510+"px";b.style.display="block";(new Typing({source:document.getElementById("source"),output:document.getElementById("output"),delay:80,brDelay:1E3,end:function(){setTimeout(function(){document.getElementById("typing-cursor").remove();a()},300)}})).start()},1E3)})}createHeart();
